{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-grid.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-theme-alpine.css">

<style>
    .content { padding: 0 !important; }
    
    .excel-header {
        background: linear-gradient(135deg, #417690 0%, #2e5266 100%);
        color: white;
        padding: 20px 30px;
        border-bottom: 3px solid #1e3a4a;
    }
    
    .excel-header h1 {
        margin: 0 0 5px 0;
        font-size: 24px;
        font-weight: 600;
    }
    
    .excel-header .breadcrumbs {
        color: rgba(255,255,255,0.8);
        font-size: 13px;
        margin: 0;
    }
    
    .excel-header .breadcrumbs a {
        color: white;
        text-decoration: none;
    }
    
    /* ✅ NEW: Search Bar Styles */
    .search-bar {
        background: white;
        padding: 15px 30px;
        border-bottom: 2px solid #e0e0e0;
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .search-input-group {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
        min-width: 250px;
    }
    
    .search-input-group label {
        font-weight: 600;
        font-size: 13px;
        color: #333;
        white-space: nowrap;
    }
    
    .search-input-group input,
    .search-input-group select {
        flex: 1;
        padding: 8px 12px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        transition: border-color 0.3s;
    }
    
    .search-input-group input:focus,
    .search-input-group select:focus {
        outline: none;
        border-color: #417690;
    }
    
    .search-actions {
        display: flex;
        gap: 8px;
    }
    
    .btn-search {
        background: #417690;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        transition: all 0.3s;
    }
    
    .btn-search:hover {
        background: #2e5266;
        transform: translateY(-1px);
    }
    
    .btn-clear {
        background: #6c757d;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        transition: all 0.3s;
    }
    
    .btn-clear:hover {
        background: #5a6268;
        transform: translateY(-1px);
    }
    
    .controls-bar {
        background: #f8f9fa;
        padding: 15px 30px;
        border-bottom: 1px solid #ddd;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .btn {
        padding: 10px 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .cell-error {
        background-color: #f8d7da !important;
        color: #721c24 !important;
        border: 2px solid #dc3545 !important;
    }
    
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .btn-primary { background: #417690; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-info { background: #17a2b8; color: white; }
    .btn-warning { background: #ffc107; color: #333; }
    .btn-danger { background: #dc3545; color: white; }
    
    .status {
        margin-left: auto;
        padding: 8px 15px;
        background: #e7f3ff;
        border-radius: 5px;
        font-weight: 600;
        font-size: 13px;
        color: #0066cc;
    }
    
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.warning { background: #fff3cd; color: #856404; }
    
    .grid-container {
        margin: 20px 30px;
        background: white;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    
    #myGrid {
        height: calc(100vh - 400px);
        min-height: 500px;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    
    .loading-overlay.active { display: flex; }
    
    .loading-content {
        background: white;
        padding: 30px 50px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    
    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #417690;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .ag-cell-inline-editing {
        background-color: #fff3cd !important;
        box-shadow: inset 0 0 0 2px #ffc107;
    }

    .cell-disabled {
        background-color: #f1f1f1 !important;
        color: #999 !important;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="excel-header">
    <div class="breadcrumbs">
        <a href="/admin/">Home</a> › 
        <a href="/admin/project/{{ model_name }}/">{{ model_verbose_name }}s</a> › 
        Excel View
    </div>
    <h1> {{ model_verbose_name }} - Excel View</h1>
</div>

<!-- ✅ NEW: Search Bar -->
<div class="search-bar">
    {% if enable_grant_selector %}
    <div class="search-input-group">
        <label> Grant No:</label>
        <input type="text" id="searchGrantNo" placeholder="Search by grant number or short no...">
    </div>
    {% else %}
    <div class="search-input-group">
        <label> Project No:</label>
        <input type="text" id="searchProjectNo" placeholder="Search by project number...">
    </div>
    {% endif %}
    
    <div class="search-input-group">
        <label> Date From:</label>
        <input type="date" id="searchDateFrom">
    </div>
    
    <div class="search-input-group">
        <label> Date To:</label>
        <input type="date" id="searchDateTo">
    </div>
    
    <div class="search-actions">
        <button class="btn-search" onclick="applySearch()"> Search</button>
        <button class="btn-clear" onclick="clearSearch()"> Clear</button>
    </div>
</div>
{% if model_name == 'billinward' %}
<div style="background:white; padding:10px 30px; border-bottom:1px solid #ddd;">
    <label style="font-weight:600;">Filter by Status:</label>
    <select id="statusFilter" onchange="applyStatusFilter()" 
        style="padding:6px 10px; border:2px solid #ccc; border-radius:5px;">
        <option value="">All</option>
        <option value="pending">Pending</option>
        <option value="processed">Processed</option>
        <option value="returned">Returned</option>
    </select>
</div>
{% endif  %}

<div class="controls-bar">
    {% if has_add_permission %}
    <button class="btn btn-primary" onclick="addNewRow()"> Add Row</button>
    {% endif %}
    
    {% if has_change_permission %}
    <button class="btn btn-success" onclick="saveChanges()">
        
         Save Changes</button>
    {% endif %}
    
    
    
    <button class="btn btn-warning" onclick="refreshData()"> Refresh</button>
    
    {% if has_delete_permission %}
    <button class="btn btn-danger" onclick="deleteSelected()"> Delete Selected</button>
    {% endif %}
    
    <span class="status" id="statusMessage">Ready</span>
</div>
<div id="summaryBar" style="
    padding: 10px 25px;
    background: #eef5ff;
    border-bottom: 2px solid #d0ddf0;
    font-weight: 600;
    display: flex;
    gap: 40px;
    align-items: center">
</div>

<div class="grid-container">
    <div id="myGrid" class="ag-theme-alpine"></div>
</div>

<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <h3>Processing...</h3>
        <p>Please wait</p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/ag-grid-community.min.js"></script>
<!-- DEBUG SCRIPT START -->
<!-- DEBUG: Check template data in console -->
 

<script>
    console.log(" ACTIVE TEMPLATE VERSION = V1000");
    console.log(" MODEL_NAME:", "{{ model_name }}");
    console.log(" HAS_GRANTS:", "{{ has_grants }}");

    console.log(" ADMIN_USERS:", {{ admin_users|safe }});
    console.log(" TDS_SECTIONS:", {{ tds_sections|safe }});
    console.log(" TDS_RATES:", {{ tds_rates|safe }});

    {% if enable_grant_selector %}
    console.log(" SEED_GRANTS:", {{ seed_grants|safe }});
    console.log(" TDG_GRANTS:", {{ tdg_grants|safe }});
    console.log(" HEADS:", {{ heads|safe }});
    {% else %}
    console.log("ℹ No grants for this model.");
    {% endif %}

    console.log(" FIELDS_CONFIG:", {{ fields_config|safe }});
</script>


<script>
    const MODEL_NAME = "{{ model_name }}";
    const PRIMARY_KEY = "id";
    window.heads = {{ heads|safe }};
    window.projects = {{ projects|safe }};
    window.faculties = {{ faculties|safe }};
    window.copis = {{ copis|default:"[]"|safe}};
    const ADMIN_USERS = {{ admin_users|safe }};
    const API_URL = `/api/${MODEL_NAME}/`;
    const FIELDS_CONFIG = {{ fields_config|safe }};
    const FACULTIES = {{ faculties|safe }};
    const TDS_SECTIONS = {{ tds_sections|safe}};
    const TDS_RATES = {{tds_rates|safe}};
    const HAS_GRANTS_SELECTOR = {{ enable_grant_selector|lower }};
    window.payees = {{payees|safe}};
    window.banks = {{banks|safe}};
    window.payment_types = {{payment_types|safe}};

    const ENABLE_GENERIC_FK_DROPDOWN = true;
    const DATE_VALIDATION_MODELS = ["expenditure", "commitment", "receipt","payment" ];
    
    {% if enable_grant_selector %}
    const SEED_GRANTS = {{ seed_grants|safe }};
    const TDG_GRANTS = {{ tdg_grants|safe }};
    const HEADS = {{ heads|safe }};
    {% endif %}
    
    let gridApi;
    let allData = [];
    let modifiedRows = new Map();
    
    const columnDefs = buildColumnDefinitions();
    
    const gridOptions = {
        columnDefs: columnDefs,
        defaultColDef: {
            sortable: true,
            filter: true,
            resizable: true
        },
        rowSelection: 'multiple',
        animateRows: true,
        enableCellChangeFlash: true,
        singleClickEdit: true,
        enableBrowserTooltips: true,
        stopEditingWhenCellsLoseFocus: true,
        onCellValueChanged: (e) => {
            trackChange(e.data);
        },
        onSelectionChanged: updateStats,
        pagination: true,
        paginationPageSize: 100,
        paginationPageSizeSelector: [50, 100, 250, 500],
    };
    
    document.addEventListener('DOMContentLoaded', function() {
        gridApi = agGrid.createGrid(document.querySelector('#myGrid'), gridOptions);
        loadData();
    });
    
    let activeErrorPopup = null;

    function showCellErrorPopup(params, message) {
        removeCellErrorPopup();

        let targetEl = null;

        const instances = params.api.getCellRendererInstances({
            rowNodes: [params.node],
            columns: [params.column.getColId()]
        });

        if (instances && instances.length && instances[0].eGui) {
            targetEl = instances[0].eGui;
        }

        if (!targetEl) {
            const active = document.querySelector('.ag-cell-inline-editing, .ag-popup-editor');
            if (active) {
                targetEl = active;
            }

        }
        if (!targetEl) {
            const focused = document.querySelector('.ag-cell-focus');
            if (focused) {
                targetEl = focused;
            }
        }

        if(!targetEl) return;


        const rect = targetEl.getBoundingClientRect();

        const popup = document.createElement("div");
        popup.innerText = message;
        

        popup.style.position = "fixed";
        popup.style.left = rect.left + "px";
        popup.style.top = (rect.top - 36) + "px";
        popup.style.background = "#dc3545";
        popup.style.color = "white";
        popup.style.padding = "6px 10px";
        popup.style.borderRadius = "4px";
        popup.style.fontWeight = "12px";
        popup.style.fontWeight = "600";
        popup.style.zIndex = 99999;
        popup.style.boxShadow = "0 4px 10px rgba(0,0,0,0.3)";
        popup.style.pointerEvents = "none";
        popup.style.whiteSpace = "nowrap";

        document.body.appendChild(popup);
        activeErrorPopup = popup;
    }

    function removeCellErrorPopup() {
        if (activeErrorPopup) {
            activeErrorPopup.remove();
            activeErrorPopup = null;
        }
    }
   
    function resolveEndDate(row) {
        if (row.seed_grant_short) {
            const g = SEED_GRANTS.find(x => String(x.short_no) === String(row.seed_grant_short));
            if (g) {
                return g.is_extended && g.extended_end_date_str
                    ? g.extended_end_date_str
                    : g.end_date_str;
            }
        }
        if (row.tdg_grant_short) {
            const g = TDG_GRANTS.find(x => String(x.short_no) === String(row.tdg_grant_short));
            if (g) {
                return g.is_extended && g.extended_end_date_str
                    ? g.extended_end_date_str
                    : g.end_date_str;
            }
        }

        if (row.project) {
            const p = window.projects.find(x => String(x.id) === String(row.project));
        
            if (p) {
                return p.extended_end_date_str
                    ? p.extended_end_date_str
                    : p.end_date_str;

            }
        }

        return null;
    }

    function validateDateForRow(row, newDate) {
        const endDate = resolveEndDate(row);

        if (!endDate) {
            return {
                ok: false,
                message: "End date not found. Please select Project / Grant first."
            };
        }

        if (new Date(newDate) > new Date(endDate)) {
            return {
                ok: false,
                message: "Date cannot be after " + endDate
            };
        }

        return { ok: true };
    }
    
    function buildColumnDefinitions() {
        const cols = [
            {
                headerName: "",
                checkboxSelection: true,
                headerCheckboxSelection: true,
                width: 50,
                pinned: 'left'
            },   
        ];
        if (MODEL_NAME === "billinward"){
            cols.push({
                headerName: "Bill PDF",
                field: "bill_pdf_url",
                cellRenderer: params => {
                    const url = params.data.bill_pdf_url;
                    const canUpload = params.data.can_upload_pdf;
                    const id = params.data.id;

                    if(url) {
                        let html = `<a href="${url}" target="_blank">View</a>`;

                        if (canUpload) {
                            html += ` | <button onclick="uploadPdf(${id})">Replace</button>`;
                        }
                        return html;
                    }

                    if (canUpload) {
                        return `<button onclick="uploadPdf(${id})">Upload</button>`;
                

                
                     
                    }
                    return "No File";
                },
                width: 120,
                pinned: 'right'
            });
        }
        

             

        cols.push({
            headerName: "ID",
            field: PRIMARY_KEY,
            width: 120,
            editable: params => params.data._isNew === true,
            pinned: 'left',
            cellStyle: {backgroundColor: '#f8f9fa', fontweight: 'bold'},
        });

        
         
        {% if enable_grant_selector %}
        cols.push({
            headerName: "Grant Number",
            field: "grant_no_display",
            width: 200,
            editable: false,
            cellStyle: { backgroundColor: '#fff3cd' },
            valueGetter: params => {
                if (params.data.seed_grant_short) {
                    const grant = SEED_GRANTS.find(g => g.short_no === params.data.seed_grant_short);
                    return grant ? grant.grant_no : '';
                }
                if (params.data.tdg_grant_short) {
                    const grant = TDG_GRANTS.find(g => g.short_no === params.data.tdg_grant_short);
                    return grant ? grant.grant_no : '';
                }
                return params.data.grant_no_display || '';
            }
            
         });
        
        cols.push({
            headerName: "Grant (Short)",
            field: "grant_short",
            width: 180,
            editable: true,
            cellEditor: 'agSelectCellEditor',
            cellEditorParams: {
                values: [
                    ...(SEED_GRANTS || []).map(g => `${g.short_no} (Seed)`),
                    ...(TDG_GRANTS || []).map(g => `${g.short_no} (TDG)`),
                    ...(window.projects || []).map(p=> `${p.project_short_no} (Project)`)
                ]
            },
            valueGetter: params => {
                if (params.data.seed_grant_short) return `${params.data.seed_grant_short} (Seed)`;
                if (params.data.tdg_grant_short) return `${params.data.tdg_grant_short} (TDG)`;

                if (params.data.project) {
                    const p = window.projects.find(
                        x => String(x.id) === String(params.data.project)

                    );
                    return p ? `${p.project_short_no} (Project)` : '';
                }
                return '';
            },
            valueSetter: params => {
                const value = params.newValue;
                if (!value) return false;
                
                const match = value.match(/^(\S+)\s+\((Seed|TDG|Project)\)$/);
                if (!match) return false;
                
                const [, shortNo, type] = match;

                params.data.seed_grant = null;
                params.data.seed_grant_short = null;
                params.data.tdg_grant = null;
                params.data.tdg_grant_short = null;
                params.data.project = null;


                    
                if (type === 'Seed') {
                    const g = SEED_GRANTS.find(g => g.short_no === shortNo);
                    
                    if (!g) return false;

                    params.data.seed_grant = g.id;
                    params.data.seed_grant_short = g.short_no;
                    params.data.grant_no_display = g.grant_no;    

                            

                           
                        
                } 
                else if (type === "TDG") {
                    const g = TDG_GRANTS.find(x => x.short_no === shortNo);
                    if (!g) return false;

                   params.data.tdg_grant = g.id;
                   params.data.tdg_grant_short = g.short_no;
                   params.data.grant_no_display = g.grant_no;
                } 
                
                else if (type === "Project") {
                    const p = window.projects.find(x => x.project_short_no === shortNo);
                    if (!p) return false;

                    params.data.project = p.id;
                    params.data.grant_no_display = p.project_no;
                }
                
                trackChange(params.data);
                
                params.api.refreshCells({
                    rowNodes: [params.node],
                    columns: ['grant_no_display'],
                    force: true
                });
                    
                return true;
                }
                
            
        });
        {% endif %}

        if (MODEL_NAME === "projectsanctiondistribution") {
            cols.push({
                headerName: "Project Short No",
                field: "project_short_no_display",
                width: 180,
                editable: false,
                cellStyle: { backgroundColor: "#f1f1f1", color: "#555", fontWeight: "600"},
            });

            cols.push({
                headerName: "Project No",
                field: "project_no_display",
                width: 220,
                editable: false,
                cellStyle: { backgroundColor: "#f1f1f1", color: "#555", fontWeight: "600"},


            });
        }
        
        FIELDS_CONFIG.forEach(field => {
            
            if (field.name === "id") return;

            if (field.name === PRIMARY_KEY) return;

            const colDef = {
                headerName: field.label,
                field: field.name,
                width: field.width || 220,
                editable: field.editable,
            }

            if (field.name === "project_status") {
                cols.push({
                    headerName: field.label,
                    field: "project_status",
                    width: 140,
                    editable: false,
                    cellStyle: { backgroundColor: "#f1f1f1", color: "#555", fontWeight: "bold" }

                });
                return;
            }

            if (field.name === "extension_approved_by") {
                cols.push({
                    headerName: field.label,
                    field: "extension_approved_by_name",
                    width: 180,
                    editable: false,
                    
                    cellStyle: { backgroundColor: "#f1f1f1", color: "#555" }

                });
                return;
            }



            if (field.name === "is_extended") {
                cols.push({
                    headerName: field.label,
                    field: "is_extended",
                    width: 120,
                    editable: true,
                    cellEditor: "agSelectCellEditor",
                    cellEditorParams: {
                        values: [true, false]
                    },
                    valueParser: params => params.newValue === "true",
                    valueFormatter: p => p.value === true ? "Yes" : "No",
                    onCellValueChanged: params => {
                        if (params.data.is_extended !== true) {
                            params.data.extended_end_date = null;
                        }
                        params.api.refreshCells({
                            rowNodes: [params.node],
                            columns: ["extended_end_date"],
                            force:true
                        });
                        trackChange(params.data);
                    }
                });
                return;
            }

            if (field.name === "extended_end_date") {
                cols.push({
                    headerName: field.label,
                    field: "extended_end_date",
                    width: field.width || 140,
                    cellEditor: "agDateStringCellEditor",
                    filter: "agDateColumnFilter",
                    editable: params => params.data.is_extended === true,
                    cellClassRules: {
                        "cell-disabled": params => params.data.is_extended !== true
                    }
                });
                return;
            }

            if (field.name === "extension_reason") {
                cols.push({
                    headerName: field.label,
                    field: "extension_reason",
                    width: field.width || 200,
                    cellEditor: "agLargeTextCellEditor",
                    cellEditorPopup: true,

                    editable: params => params.data.is_extended === true,
                    cellClassRules: {
                        "cell-disabled": params => params.data.is_extended !== true
                    }
                });
                return;
            }


            if (MODEL_NAME !== "projectsanctiondistribution") {
                if (field.name === 'PRIMARY_KEY' || field.name === 'seed_grant' || field.name === 'tdg_grant' || field.name === 'project' ) {
                    return;
                }
            }

            if(field.name === "tds_section"){
                cols.push({
                    headerName: field.label,       // OR "TDS Section"
                    field: "tds_section",
                    width: field.width || 150,
                    editable: field.editable,
                    cellEditor: 'agSelectCellEditor',
                    cellEditorParams: {
                        values: TDS_SECTIONS.map(s => String(s.id))
                    },
                    valueFormatter: params => {
                        const sec = TDS_SECTIONS.find(s => String(s.id) === String(params.value));
                        return sec ? sec.code : "";
                    },
                    valueParser: params => parseInt(params.newValue || params.value)

                });
                return;
            }

            if (field.name === "tds_rate") {
                cols.push({
                    headerName: field.label,    // OR "TDS Rate(%)"
                    field: "tds_rate",
                    width: field.width || 150,
                    editable: field.editable,
                    cellEditor: 'agSelectCellEditor',
                    cellEditorParams: params => {
                        if (!params.data.tds_section) return { values: [] };
                        const filtered = TDS_RATES.filter(
                            r => Number(r.section_id) === Number(params.data.tds_section)
                        );
                        return { values: filtered.map(r => String(r.id)) };
                    },
                    valueFormatter: params => {
                        const rate = TDS_RATES.find(r => String(r.id) === String(params.value));
                        return rate ? rate.percent + "%" : "";
                    },
                    valueParser: params => parseInt(params.newValue || params.value)
                });
                return;
            }
            if (field.name === "financial_year") {
                colDef.cellEditor = "agTextCellEditor"
                colDef.cellEditorParams = {
                    macLength: 7,
                    placeholder: "YYYY-YY"
                };

                colDef.valueSetter = params => {
                    const value = (params.newValue || "").trim();

                    if (!value) {
                        params.data.financial_year ="";
                        return true;
                    }

                    const fyRegex = /^\d{4}-\d{2}$/;

                    if (!fyRegex.test(value)) {
                        showCellErrorPopup(
                            params,
                            "Invalid format. Use YYYY-YY (e.g. 2024-25)"
                        );
                        return false;
                    }

                    removeCellErrorPopup();
                    params.data.financial_year = value;
                    trackChange(params.data);
                    return true;
                }

                
            };

            
            if (field.name === "faculty") {
                cols.push({
                    headerName: "Faculty ID",
                    field: "faculty",
                    width: 150,
                    editable: true,
                    cellEditor: "agSelectCellEditor",
                    cellEditorParams: {
                        values: FACULTIES.map(f => f.faculty_id)
                    },
                    valueFormatter: params => {
                        const f = FACULTIES.find(x => x.faculty_id === params.value);
                        return f ? f.faculty_id : "";
                    },
                    valueSetter: params => {
                        const facultyId = params.newValue;
                        const f = FACULTIES.find(x => x.faculty_id === facultyId);

                        params.data.faculty = facultyId;

                        if (f) {
                            params.data.pi_name = f.pi_name;
                            params.data.dept = f.department;
                        }

                        trackChange(params.data);

                        params.api.refreshCells({
                            rowNodes: [params.node],
                            columns: ['pi_name', 'dept'],
                            force: true
                        });
                        return true;
                    } 
                });
                return;
            }

            

            if (field.name === "payee_pan") {
                cols.push({
                    headerName: "PAN",
                    field: "payee_pan",
                    width: 250,
                    editable: true,
                    cellEditor: "agSelectCellEditor",
                    cellEditorParams: {
                        values: window.payees.map(p => String(p.pan))
                    },
                    

                    
                    valueSetter: params => {
                        const pan = params.newValue;
                        const p = window.payees.find(x => String(x.pan) === String(pan));

                       

                        if (!p) return false; 
                        params.data.payee = p.id;
                        

                        params.data.payee_pan = p.pan;
                        params.data.payee_bank_name = p.bank_name;
                        params.data.payee_branch_name = p.branch;
                        params.data.payee_account_no = p.account_number;
                        params.data.payee_ifsc = p.ifsc;
                            
                        params.data.payee_email = p.email;
                        

                        trackChange(params.data);

                        params.api.refreshCells({
                            rowNodes: [params.node],
                            columns: [
                                "payee",
                                "payee_pan",
                                
                                "payee_bank_name",
                                "payee_branch_name",
                                "payee_account_no",
                                "payee_ifsc",
                                
                                "payee_email",
                            ],
                            force: true

                        });

                        return true;
                    }
                });
                return
            }

                
            







                



                
            
            
            

            if(field.name === "whom_to") {
                colDef.cellEditor = "agSelectCellEditor";
                colDef.cellEditorParams = {
                    values: ADMIN_USERS.map(u => String(u.id))
                };

                colDef.valueFormatter = params => {
                    const user = ADMIN_USERS.find(u => String(u.id) === String(params.value))
                    return user ? user.name : "";
                };

                colDef.valueParser = params => parseInt(params.newValue);

            }
            
            if (
                field.type === 'DateField' ) {
                colDef.cellEditor = 'agDateStringCellEditor';
                colDef.filter = 'agDateColumnFilter';

                colDef.cellClassRules = {
                    "cell-error": params => !!params.data._date_error
                };
                
                

                colDef.valueSetter = params => {
                    const newDate = params.newValue;
                    const oldDate = params.oldValue;

                    params.data._date_error = null;

                    if (newDate === oldDate) return false;

                    if (!newDate) {
                        params.data[field.name] = null;
                        trackChange(params.data);
                        return true;
                    }
                
                    if (DATE_VALIDATION_MODELS.includes(MODEL_NAME) && field.name === "bill_date") {
                        const result = validateDateForRow(params.data, newDate);
                
                        if (!result.ok) {
                            params.data._date_error = result.message;

                            showCellErrorPopup(params, result.message);

                            params.api.refreshCells({
                                rowNodes: [params.node],
                                columns: [field.name],
                                force: true
                            });

                            return false;
                        }
                    }

                   
                    params.data[field.name] = newDate;

                    params.data._date_error = null;
                    removeCellErrorPopup();
                    trackChange(params.data);
                    return true;
                };

            } else if (field.type === 'DecimalField' || field.type === 'FloatField') {
                colDef.valueFormatter = params => {
                    if (params.value == null) return '';
                    return '₹' + parseFloat(params.value).toLocaleString('en-IN', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                };
            
                colDef.cellStyle = { textAlign: 'right', fontWeight: 'bold', color: '#d9534f' };
            } else if (field.type === 'TextField') {
                colDef.cellEditor = 'agLargeTextCellEditor';
                colDef.cellEditorPopup = true;
            } else if (field.choices && field.choices.length > 0) {
                colDef.cellEditor = 'agSelectCellEditor';
                colDef.cellEditorParams = { values: field.choices };
            }
            
            {% if enable_grant_selector %}
            if (field.name === 'head') {
                colDef.cellEditor = 'agSelectCellEditor';
                colDef.cellEditorParams = { values: HEADS };
            }

            
            {% endif %}
            if(
                ENABLE_GENERIC_FK_DROPDOWN &&
                field.type === 'ForeignKey' &&
                field.dropdown 
    
            ) {
                const data = window[field.dropdown] || [];

                colDef.cellEditor = 'agSelectCellEditor';

                // Always work with STRING inside dropdown
                colDef.cellEditorParams = {
                    values:["", ...data.map(item => String(item[field.valueField]))]
                };

                colDef.valueFormatter = params => {
                    const found = data.find(
                        x => String(x[field.valueField]) === String(params.value)
                    );
                    return found ? found[field.labelField] : "";
                };

                colDef.valueSetter = params => {
                    const val = params.newValue;

                    if (val === "" || val == null) {
                        params.data[field.name] = null;
                        trackChange(params.data);
                        return true;
                    }
        

                    const found = data.find(
                        x => String(x[field.valueField]) === String(val)
                    );

                    if (!found) return false;

                    if (MODEL_NAME === "projectsanctiondistribution") {
                        params.data[field.name] = String(found[field.valueField]);
                    } else {
                        params.data[field.name] = Number(found[field.valueField]);
                    }

 
                    

                    if (MODEL_NAME === "projectsanctiondistribution" && field.name === "project") {
                        params.data.project_short_no_display = found.project_short_no || "";
                        params.data.project_no_display = found.project_no || "";

                        params.api.refreshCells({
                            rowNodes: [params.node],
                            columns: ["project_short_no_display", "project_no_display"],
                            force: true
                        });
                    }


                    trackChange(params.data);
                    return true;
                };
            }          
 

            
            cols.push(colDef);
        });
        
        
        return cols;
    }
    
    function loadData() {
        showLoading(true);
        fetch(API_URL, { credentials: "same-origin"})
            .then(response => response.json())
            .then(data => {

                if (MODEL_NAME === "projectsanctiondistribution") {
                    data.forEach(row => {
                        if (row.project) {
                            const p = (window.projects || []).find(
                                x => Number(x.id) === Number(row.project)
                            );

                            row.project_short_no_display = p ? (p.project_short_no || "") : "";
                            row.project_no_display = p ? (p.project_no || "") : "";
                        } else {
                            row.project_short_no_display = "";
                            row.project_no_display = "";
                        }
                    });
                }

                if (MODEL_NAME === "projectsanctiondistribution") {
                    data.forEach(row => {
                        if (row.project != null) row.project = String(row.project);
                        if (row.head != null) row.head = String(row.head);
                    });
                }

               
               
                allData = data;
                gridApi.setGridOption('rowData', data);

                updateSummary(data);
                
                updateStats();
                updateStatus(` Loaded ${data.length} records`, 'success');
                showLoading(false);
            })
            .catch(error => {
                console.error('Error:', error);
                updateStatus(' Error loading data', 'error');
                showLoading(false);
            });
    }
    
    // ✅ NEW: Search Function
    function applySearch() {
        const searchText = HAS_GRANTS_SELECTOR ? 
            document.getElementById('searchGrantNo').value.toLowerCase() :
            document.getElementById('searchProjectNo').value.toLowerCase();
        const dateFrom = document.getElementById('searchDateFrom').value;
        const dateTo = document.getElementById('searchDateTo').value;
        
        let filteredData = [...allData];
        
        // Filter by grant/project number
        if (searchText) {
            filteredData = filteredData.filter(row => {
                if (HAS_GRANTS_SELECTOR) {
                    const grantNo = (row.grant_no_display || '').toLowerCase();
                    const shortNo = (row.seed_grant_short || row.tdg_grant_short || '').toLowerCase();
                    return grantNo.includes(searchText) || shortNo.includes(searchText);
                } else {
                    const projectNo = (row.project_no || '').toLowerCase();
                    return projectNo.includes(searchText);
                }
            });
        }
        
        // Filter by date range
        if (dateFrom) {
            filteredData = filteredData.filter(row => {
                const rowDate = row.date || '';
                return rowDate >= dateFrom;
            });
        }
        
        if (dateTo) {
            filteredData = filteredData.filter(row => {
                const rowDate = row.date || '';
                return rowDate <= dateTo;
            });
        }
        
        gridApi.setGridOption('rowData', filteredData);
        updateStatus(` Found ${filteredData.length} records`, 'success');
    }
    
    // ✅ NEW: Clear Search
    function clearSearch() {
        if (HAS_GRANTS) {
            document.getElementById('searchGrantNo').value = '';
        } else {
            document.getElementById('searchProjectNo').value = '';
        }
        document.getElementById('searchDateFrom').value = '';
        document.getElementById('searchDateTo').value = '';
        
        gridApi.setGridOption('rowData', allData);
        updateStatus(` Showing all ${allData.length} records`, 'success');
    }
    
    function addNewRow() {
        const newRow = {};
        
        newRow._isNew = true;
        
        FIELDS_CONFIG.forEach(field => {
            if (field.name === PRIMARY_KEY) return;

            if (field.name === 'date') {
                newRow[field.name] = null;
            } else if (field.type === 'DecimalField' || field.type === 'FloatField') {
                newRow[field.name] = 0;
            } else {
                newRow[field.name] = '';
                if (field.name === "faculty") newRow[field.name] = "";
                if (field.name === "pi_name") newRow[field.name] = "";
                if (field.name === "dept") newRow[field.name] = "";

            }
        });
        
        {% if enable_grant_selector %}
        newRow.seed_grant = null;
        newRow.tdg_grant = null;
        newRow.seed_grant_short = null;
        newRow.tdg_grant_short = null;
        newRow.grant_no_display = '';
        {% endif %}
        
        gridApi.applyTransaction({ add: [newRow], addIndex: -1 });
        updateStatus('New row added. Fill details and save.', 'warning');
    }
    
    async function saveChanges() {
        const allRows = [];
        gridApi.forEachNode(node => allRows.push(node.data));
        
        const newRows = allRows.filter(row => row._isNew === true);
        const updatedRows = Array.from(modifiedRows.values());
        
        if (newRows.length === 0 && updatedRows.length === 0) {
            updateStatus('No changes to save', 'warning');
            return;
        }
        
        showLoading(true);
        
        try {
            for (const row of newRows) {
                const payload = preparePayload(row);
                
                const createResponse = await fetch(API_URL, {
                    method: 'POST',
                    credentials: "same-origin",
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!createResponse.ok) {
                    const errorData = await createResponse.json();
                    throw new Error(`Create failed: ${JSON.stringify(errorData)}`);
                }
                row._isNew = false;
            }
            
            for (const row of updatedRows) {
                const payload = preparePayload(row);
                const pkValue = row[PRIMARY_KEY];
                const updateResponse = await fetch(`${API_URL}${pkValue}/`, {
                    method: 'PATCH',
                    credentials:"same-origin",
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!updateResponse.ok) {
                    const errorData = await updateResponse.json();
                    throw new Error(`Update failed: ${JSON.stringify(errorData)}`);
                }
            }
            
            modifiedRows.clear();
            updateStatus(` Saved ${newRows.length + updatedRows.length} row(s)`, 'success');
            setTimeout(() => loadData(), 1000);
            
        } catch (error) {
            console.error('Save error:', error);
            updateStatus(' Error: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    }
    
    function preparePayload(row) {
        const payload = {};
        
        FIELDS_CONFIG.forEach(field => {
            if (row[field.name] !== undefined && row[field.name] !== null) {
                payload[field.name] = row[field.name];
            }
        });
        
        delete payload.name;
        delete payload.dept;

        {% if enable_grant_selector %}
        

        
        
        delete payload.grant_no_display;
        delete payload.seed_grant_short;
        delete payload.tdg_grant_short;
        delete payload.grant_short;
        {% endif %}

        if (HAS_GRANTS_SELECTOR === true) {
            payload.seed_grant = row.seed_grant || null;
            payload.tdg_grant = row.tdg_grant || null;
            payload.project = row.project || null;
        }

        const NULL_ALLOWED_FIELDS = [
             "extended_end_date",
             "extension_reason",
             "extension_approved_by",
        
        ];
        
        Object.keys(payload).forEach(key => {
            if (
                (payload[key] === "" || payload[key] === undefined) &&
                !NULL_ALLOWED_FIELDS.includes(key)
            ) {
                delete payload[key];
            }
        });

        if (payload.is_extended !== true) {
            delete payload.extended_end_date;
            delete payload.extension_reason;
        } else {
            if (!payload.extended_end_date){
                delete payload.extended_end_date;
            }
        }

        if (MODEL_NAME === "projectsanctiondistribution") {
            if (payload.project) payload.project = parseInt(payload.project);
            if (payload.head) payload.head = parseInt(payload.head);
        }


        delete payload._isNew;
        
        return payload;
    }
    
    async function deleteSelected() {
        const selectedRows = gridApi.getSelectedRows();
        
        if (selectedRows.length === 0) {
            alert('Please select rows to delete');
            return;
        }
        
        if (!confirm(`Delete ${selectedRows.length} row(s)?`)) return;
        
        showLoading(true);
        
        try {
            for (const row of selectedRows) {
                const pkValue = row[PRIMARY_KEY];
                if (row.id) {
                    await fetch(`${API_URL}${pkValue}/`, {
                        method: 'DELETE',
                        credentials: "same-origin",
                        headers: { 'X-CSRFToken': getCookie('csrftoken') }
                    });
                }
            }
            
            gridApi.applyTransaction({ remove: selectedRows });
            updateStats();
            updateStatus(` Deleted ${selectedRows.length} row(s)`, 'success');
            
        } catch (error) {
            console.error('Delete error:', error);
            updateStatus(' Error deleting rows', 'error');
        } finally {
            showLoading(false);
        }
    }
    
    function exportToExcel() {
        gridApi.exportDataAsCsv({
            fileName: `${MODEL_NAME}_${new Date().toISOString().split('T')[0]}.csv`
        });
        updateStatus('✅ Exported to CSV', 'success');
    }
    
    function refreshData() {
        modifiedRows.clear();
        clearSearch();
        loadData();
    }

    function calculateTDS(row) {
        const tdsRateObj = TDS_RATES.find(r => Number(r.id) === Number(row.tds_rate));
        if (!tdsRateObj || !row.amount) {
            row.tds_amount = 0;
            row.net_amount = row.amount || 0;
            return;
        }
        const percent = Number(tdsRateObj.percent);
        const amount = Number(row.amount);

        row.tds_amount = (amount * percent / 100).toFixed(2);
        row.net_amount = (amount - row.tds_amount).toFixed(2);
    }
    
    function trackChange(rowData) {
        calculateTDS(rowData);
        const pkValue = rowData[PRIMARY_KEY];
        if (pkValue) { 
            modifiedRows.set(pkValue, rowData);
            updateStatus(`${modifiedRows.size} row(s) modified`, 'warning');
        }
        gridApi.refreshCells({ force: true});
    }
    function applyStatusFilter() {
        const val = document.getElementById("statusFilter").value;
        let filtered = [...allData];

        if (val) {
            filtered = filtered.filter(r => r.bill_status === val);
        }
 
        gridApi.setGridOption('rowData', filtered);
        updateSummary(filtered);

    }
    
    function updateSummary(dataList = allData) {
        const box = document.getElementById("summaryBar");

        if (!box) return;

        if (MODEL_NAME === "billinward") {
            const pending = dataList.filter(r => r.bill_status === "pending").length;
            const processed = dataList.filter(r => r.bill_status === "processed").length;
            const returned = dataList.filter(r => r.bill_status === "returned").length;

            box.innerHTML = `
               <span>Pending: <strong>${pending}</strong></span>
               <span>Processed: <strong>${processed}</strong></span>
               <span>Returned: <strong>${returned}</strong></span>
               <span>Total: <strong>${dataList.length}</strong></span>
            `;
        }

        else if (MODEL_NAME === "expenditure") {
            const total = dataList.reduce((sum, r) => sum + Number(r.amount || 0), 0);
            box.innerHTML = `
                <span>Total Expenditure Amount: <strong>₹${total.toFixed(2)}</strong></span>
            `;
        }

        else if (MODEL_NAME === "commitment") {
            const total = dataList.reduce((sum, r) => sum + Number(r.amount || 0), 0);
            box.innerHTML = `
                <span>Total Commitment Amount: <strong>₹${total.toFixed(2)}</strong></span>
            `;
        }

        else {
            box.innerHTML = "";
        }
    }




    
    function updateStats() {
        // Can be enhanced
    }
    
    function updateStatus(message, type = 'info') {
        const statusEl = document.getElementById('statusMessage');
        statusEl.textContent = message;
        statusEl.className = 'status ' + type;
    }
    
    function showLoading(show) {
        document.getElementById('loadingOverlay').classList.toggle('active', show);
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function uploadPdf(id) {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "application/pdf";

        input.onchange = async () => {
            const file = input.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append("file", file);

            showLoading(true);

            try{
                const res =await fetch(`/api/billinward/${id}/upload_pdf/`, {
                    method: "POST",
                    credentials: "same-origin",
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken")
                    },
                    body: formData
                });

                const data = await res.json();

                if (!res.ok) {
                    alert(data.error || "Upload failed");
                } else {
                    alert("Uploaded successfully");
                    loadData();
                }
            } catch (e) {
                alert("Upload failed")
            }finally {
                showLoading(false);
            }
        };
        input.click();
    }
</script>
{% endblock %}