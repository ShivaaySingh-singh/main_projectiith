{% extends "admin/base_site.html" %} {% load static %} {% block content %} <h1 style="text-align:center;">IIT Hyderabad Fund Management</h1> <style> /* ðŸ”¥ Remove up/down arrows from number inputs */ input[type=number]::-webkit-outer-spin-button, input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; } input[type=number] { -moz-appearance: textfield; } </style> <form method="POST" action="{% url 'save_fund_management' %}"> {% csrf_token %} <input type="hidden" name="project_id" id="project_id"> <input type="hidden" name="project_detail_id" id="project_detail_id"> <div style="margin:20px 0; padding:10px; border:1px solid #ccc; border-radius:8px;"> <label>From Date: <input type="date" id="from_date" name="from_date"></label> <label>To Date: <input type="date" id="to_date" name="to_date"></label> </div> <div style="margin:20px 0;"> <label>Project No: <input type="text" id="project_no" name="project_no" placeholder="Type last 4 digits"></label> <ul id="suggestions"></ul> </div> <div id="project_info" style="margin-bottom:20px;"> <p><strong>Project Title:</strong> <span id="proj_title"></span></p> <p><strong>Start Date:</strong> <span id="proj_start"></span></p> <p><strong>End Date:</strong> <span id="proj_end"></span></p> <p><strong>Duration:</strong> <input type="text" id="proj_duration" name="proj_duration"></p> <p><strong>PI Name:</strong> <input type="text" id="proj_pi" name="proj_pi"></p> </div> <table class="table table-bordered" id="fund_table"> <thead> <tr> <th>Head Name</th> <th>Sanction Amount</th> <th>Opening Balance</th> <th>Receipt</th> <th>Total</th> <th>Payments</th> <th>Balance After Payment</th> <th>Committed Bill</th> <th>Present Bill</th> <th>Balance</th> </tr> </thead> <tbody> {% for receipt in receipts %} <tr> <td> <input type="hidden" name="head_name" value="{{ receipt.category }}"> {{ receipt.category }} </td> <td><input type="number" name="sanction_amount" value="{{ receipt.amount }}"></td> <td><input type="number" name="opening_balance" value="{{ receipt.opening_balance }}"></td> <td><input type="number" name="receipt" value="{{ receipt.receipt }}"></td> <td><input type="text" name="total" value="{{ receipt.total }}" readonly></td> <td><input type="number" name="payments" value="{{ receipt.payments }}"></td> <td><input type="text" name="balance_after_payment" value="{{ receipt.balance_after_payment }}" readonly></td> <td><input type="number" name="committed_bill" value="{{ receipt.committed_bill }}"></td> <td><input type="number" name="present_bill" value="{{ receipt.present_bill }}"></td> <td><input type="text" name="balance" value="{{ receipt.balance }}" readonly></td> </tr> {% endfor %} <tr style="background:#eee; font-weight:bold;"> <td>TOTAL</td> <td><input type="text" id="tot_sanction" readonly></td> <td><input type="text" id="tot_open" readonly></td> <td><input type="text" id="tot_receipt" readonly></td> <td><input type="text" id="tot_total" readonly></td> <td><input type="text" id="tot_payments" readonly></td> <td><input type="text" id="tot_balance_after" readonly></td> <td><input type="text" id="tot_committed" readonly></td> <td><input type="text" id="tot_present" readonly></td> <td><input type="text" id="tot_balance" readonly></td> </tr> </tbody> </table> <div style="margin-top:10px;"> <button type="button" id="addRowBtn" class="btn btn-secondary">+ Add Head</button> </div> <div style="margin-top:20px; text-align:center;"> <button type="submit" class="btn btn-success">Save Fund Details</button> </div> </form> <script> /* --- Auto-calculations (unchanged) --- */ document.addEventListener("input", function(e){ if (e.target.closest("#fund_table")) { let row = e.target.closest("tr"); let sanction = parseFloat(row.querySelector('[name="sanction_amount"]')?.value) || 0; let opening = parseFloat(row.querySelector('[name="opening_balance"]')?.value) || 0; let receipt = parseFloat(row.querySelector('[name="receipt"]')?.value) || 0; let payments = parseFloat(row.querySelector('[name="payments"]')?.value) || 0; let present = parseFloat(row.querySelector('[name="present_bill"]')?.value) || 0; let total = opening + receipt; let balance_after = sanction - payments; let balance = total - payments - present; if (row.querySelector('[name="total"]')) row.querySelector('[name="total"]').value = total.toFixed(2); if (row.querySelector('[name="balance_after_payment"]')) row.querySelector('[name="balance_after_payment"]').value = balance_after.toFixed(2); if (row.querySelector('[name="balance"]')) row.querySelector('[name="balance"]').value = balance.toFixed(2); let totals = {sanction:0, opening:0, receipt:0, total:0, payments:0, balance_after:0, committed:0, present:0, balance:0}; document.querySelectorAll("#fund_table tbody tr").forEach(r=>{ if (r.querySelector('[name="sanction_amount"]')) { totals.sanction += parseFloat(r.querySelector('[name="sanction_amount"]').value) || 0; totals.opening += parseFloat(r.querySelector('[name="opening_balance"]').value) || 0; totals.receipt += parseFloat(r.querySelector('[name="receipt"]').value) || 0; totals.total += parseFloat(r.querySelector('[name="total"]').value) || 0; totals.payments += parseFloat(r.querySelector('[name="payments"]').value) || 0; totals.balance_after += parseFloat(r.querySelector('[name="balance_after_payment"]').value) || 0; totals.committed += parseFloat(r.querySelector('[name="committed_bill"]').value) || 0; totals.present += parseFloat(r.querySelector('[name="present_bill"]').value) || 0; totals.balance += parseFloat(r.querySelector('[name="balance"]').value) || 0; } }); document.getElementById("tot_sanction").value = totals.sanction.toFixed(2); document.getElementById("tot_open").value = totals.opening.toFixed(2); document.getElementById("tot_receipt").value = totals.receipt.toFixed(2); document.getElementById("tot_total").value = totals.total.toFixed(2); document.getElementById("tot_payments").value = totals.payments.toFixed(2); document.getElementById("tot_balance_after").value = totals.balance_after.toFixed(2); document.getElementById("tot_committed").value = totals.committed.toFixed(2); document.getElementById("tot_present").value = totals.present.toFixed(2); document.getElementById("tot_balance").value = totals.balance.toFixed(2); } }); /* --- Project search with title handling --- */ document.getElementById("project_no").addEventListener("input", function(){ let q = this.value; if (q.length >= 4){ fetch(/get_project?q=${q}) .then(res=>res.json()) .then(data=>{ let list = document.getElementById("suggestions"); list.innerHTML=""; data.forEach(p=>{ let li=document.createElement("li"); li.innerText=${p.project_no}; li.onclick=function(){ document.getElementById("project_id").value=p.id; document.getElementById("project_no").value=p.project_no; list.innerHTML=""; if (p.details.length === 1){ let d = p.details[0]; document.getElementById("project_detail_id").value = d.id; document.getElementById("proj_title").innerText = d.title; document.getElementById("proj_start").innerText = d.start_date; document.getElementById("proj_end").innerText = d.end_date; } else { let titleList = document.createElement("ul"); p.details.forEach(d=>{ let tli = document.createElement("li"); tli.innerText = ${d.title} (${d.start_date} â†’ ${d.end_date}); tli.onclick = function(){ document.getElementById("project_detail_id").value = d.id; document.getElementById("proj_title").innerText = d.title; document.getElementById("proj_start").innerText = d.start_date; document.getElementById("proj_end").innerText = d.end_date; titleList.innerHTML=""; }; titleList.appendChild(tli); }); document.getElementById("project_info").appendChild(titleList); } }; list.appendChild(li); }); }); } }); /* --- Add Head row dynamically --- */ document.getElementById("addRowBtn").addEventListener("click", function(){ let tbody = document.querySelector("#fund_table tbody"); let newRow = document.createElement("tr"); newRow.innerHTML = <td><input type="text" name="head_name" placeholder="Enter Head"></td> <td><input type="number" name="sanction_amount"></td> <td><input type="number" name="opening_balance"></td> <td><input type="number" name="receipt"></td> <td><input type="text" name="total" readonly></td> <td><input type="number" name="payments"></td> <td><input type="text" name="balance_after_payment" readonly></td> <td><input type="number" name="committed_bill"></td> <td><input type="number" name="present_bill"></td> <td><input type="text" name="balance" readonly></td> ; tbody.appendChild(newRow); }); </script> {% endblock %}