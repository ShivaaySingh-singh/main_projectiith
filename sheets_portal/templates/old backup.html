{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-grid.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-theme-alpine.css">

<style>
    /* ‚úÖ Same CSS as before - copying from your existing template */
    .content { padding: 0 !important; }
    
    .excel-header {
        background: linear-gradient(135deg, #417690 0%, #2e5266 100%);
        color: white;
        padding: 20px 30px;
        border-bottom: 3px solid #1e3a4a;
    }
    
    .excel-header h1 {
        margin: 0 0 5px 0;
        font-size: 24px;
        font-weight: 600;
    }
    
    .excel-header .breadcrumbs {
        color: rgba(255,255,255,0.8);
        font-size: 13px;
        margin: 0;
    }
    
    .excel-header .breadcrumbs a {
        color: white;
        text-decoration: none;
    }
    
    .controls-bar {
        background: #f8f9fa;
        padding: 15px 30px;
        border-bottom: 1px solid #ddd;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .btn {
        padding: 10px 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .btn-primary { background: #417690; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-info { background: #17a2b8; color: white; }
    .btn-warning { background: #ffc107; color: #333; }
    .btn-danger { background: #dc3545; color: white; }
    
    .status {
        margin-left: auto;
        padding: 8px 15px;
        background: #e7f3ff;
        border-radius: 5px;
        font-weight: 600;
        font-size: 13px;
        color: #0066cc;
    }
    
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.warning { background: #fff3cd; color: #856404; }
    
    .grid-container {
        margin: 20px 30px;
        background: white;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    
    #myGrid {
        height: calc(100vh - 350px);
        min-height: 500px;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    
    .loading-overlay.active { display: flex; }
    
    .loading-content {
        background: white;
        padding: 30px 50px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    
    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #417690;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .ag-cell-inline-editing {
        background-color: #fff3cd !important;
        box-shadow: inset 0 0 0 2px #ffc107;
    }
</style>
{% endblock %}

{% block content %}
<div class="excel-header">
    <div class="breadcrumbs">
        <a href="/admin/">Home</a> ‚Ä∫ 
        <a href="/admin/project/{{ model_name }}/">{{ model_verbose_name }}s</a> ‚Ä∫ 
        Excel View
    </div>
    <h1>üìä {{ model_verbose_name }} - Excel View</h1>
</div>

<div class="controls-bar">
    {% if has_add_permission %}
    <button class="btn btn-primary" onclick="addNewRow()">‚ûï Add Row</button>
    {% endif %}
    
    {% if has_change_permission %}
    <button class="btn btn-success" onclick="saveChanges()">üíæ Save Changes</button>
    {% endif %}
    
    <button class="btn btn-info" onclick="exportToExcel()">üì• Export CSV</button>
    
    <button class="btn btn-warning" onclick="refreshData()">üîÑ Refresh</button>
    
    {% if has_delete_permission %}
    <button class="btn btn-danger" onclick="deleteSelected()">üóëÔ∏è Delete Selected</button>
    {% endif %}
    
    <span class="status" id="statusMessage">Ready</span>
</div>

<div class="grid-container">
    <div id="myGrid" class="ag-theme-alpine"></div>
</div>

<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <h3>Processing...</h3>
        <p>Please wait</p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/ag-grid-community.min.js"></script>

<script>
    // ‚úÖ Django context variables
    const MODEL_NAME = "{{ model_name }}";
    const API_URL = `/api/${MODEL_NAME}/`;
    const FIELDS_CONFIG = {{ fields_config|safe }};
    const HAS_GRANTS = {{ has_grants|lower }};
    
    {% if has_grants %}
    const SEED_GRANTS = {{ seed_grants|safe }};
    const TDG_GRANTS = {{ tdg_grants|safe }};
    const HEADS = {{ heads|safe }};
    {% endif %}
    
    let gridApi;
    let allData = [];
    let modifiedRows = new Map();
    
    // ‚úÖ Build column definitions dynamically
    const columnDefs = buildColumnDefinitions();
    
    const gridOptions = {
        columnDefs: columnDefs,
        defaultColDef: {
            sortable: true,
            filter: true,
            resizable: true
        },
        rowSelection: 'multiple',
        animateRows: true,
        enableCellChangeFlash: true,
        singleClickEdit: true,
        stopEditingWhenCellsLoseFocus: true,
        onCellValueChanged: (e) => trackChange(e.data),
        onSelectionChanged: updateStats,
        pagination: true,
        paginationPageSize: 100,
        paginationPageSizeSelector: [50, 100, 250, 500],
    };
    
    document.addEventListener('DOMContentLoaded', function() {
        gridApi = agGrid.createGrid(document.querySelector('#myGrid'), gridOptions);
        loadData();
    });
    
    // ‚úÖ Build column definitions based on model fields
    function buildColumnDefinitions() {
        const cols = [
            {
                headerName: "",
                checkboxSelection: true,
                headerCheckboxSelection: true,
                width: 50,
                pinned: 'left'
            },
            {
                headerName: "ID",
                field: "id",
                width: 80,
                editable: false,
                cellStyle: { backgroundColor: '#f8f9fa', fontWeight: 'bold' },
                pinned: 'left'
            }
        ];
        
        {% if has_grants %}
        // ‚úÖ Add grant-specific columns
        cols.push({
            headerName: "Grant Number",
            field: "grant_no_display",
            width: 200,
            editable: false,
            cellStyle: { backgroundColor: '#fff3cd' },
            valueGetter: params => {
                if (params.data.seed_grant_short) {
                    const grant = SEED_GRANTS.find(g => g.short_no === params.data.seed_grant_short);
                    return grant ? grant.grant_no : '';
                }
                if (params.data.tdg_grant_short) {
                    const grant = TDG_GRANTS.find(g => g.short_no === params.data.tdg_grant_short);
                    return grant ? grant.grant_no : '';
                }
                return params.data.grant_no_display || '';
            }
        });
        
        cols.push({
            headerName: "Grant (Short)",
            field: "grant_short",
            width: 180,
            editable: true,
            cellEditor: 'agSelectCellEditor',
            cellEditorParams: {
                values: [
                    ...SEED_GRANTS.map(g => `${g.short_no} (Seed)`),
                    ...TDG_GRANTS.map(g => `${g.short_no} (TDG)`)
                ]
            },
            valueGetter: params => {
                if (params.data.seed_grant_short) return `${params.data.seed_grant_short} (Seed)`;
                if (params.data.tdg_grant_short) return `${params.data.tdg_grant_short} (TDG)`;
                return '';
            },
            valueSetter: params => {
                const value = params.newValue;
                if (!value) return false;
                
                const match = value.match(/^(\S+)\s+\((Seed|TDG)\)$/);
                if (match) {
                    const [, shortNo, type] = match;
                    
                    if (type === 'Seed') {
                        const grant = SEED_GRANTS.find(g => g.short_no === shortNo);
                        if (grant) {
                            params.data.seed_grant = shortNo;
                            params.data.seed_grant_short = shortNo;
                            params.data.grant_no_display = grant.grant_no;
                            params.data.tdg_grant = null;
                            params.data.tdg_grant_short = null;
                        }
                    } else {
                        const grant = TDG_GRANTS.find(g => g.short_no === shortNo);
                        if (grant) {
                            params.data.tdg_grant = shortNo;
                            params.data.tdg_grant_short = shortNo;
                            params.data.grant_no_display = grant.grant_no;
                            params.data.seed_grant = null;
                            params.data.seed_grant_short = null;
                        }
                    }
                    
                    trackChange(params.data);
                    params.api.refreshCells({
                        rowNodes: [params.node],
                        columns: ['grant_no_display'],
                        force: true
                    });
                    
                    return true;
                }
                return false;
            }
        });
        {% endif %}
        
        // ‚úÖ Add regular fields
        FIELDS_CONFIG.forEach(field => {
            // Skip grant fields and ID (already added)
            if (field.name === 'id' || field.name === 'seed_grant' || field.name === 'tdg_grant') {
                return;
            }
            
            const colDef = {
                headerName: field.label,
                field: field.name,
                width: field.width || 150,
                editable: field.editable,
            };
            
            // ‚úÖ Field-specific configurations
            if (field.type === 'DateField') {
                colDef.cellEditor = 'agDateStringCellEditor';
                colDef.filter = 'agDateColumnFilter';
            } else if (field.type === 'DecimalField' || field.type === 'FloatField') {
                colDef.valueFormatter = params => {
                    if (params.value == null) return '';
                    return '‚Çπ' + parseFloat(params.value).toLocaleString('en-IN', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                };
                colDef.cellStyle = { textAlign: 'right', fontWeight: 'bold', color: '#d9534f' };
            } else if (field.type === 'TextField') {
                colDef.cellEditor = 'agLargeTextCellEditor';
                colDef.cellEditorPopup = true;
            } else if (field.choices && field.choices.length > 0) {
                colDef.cellEditor = 'agSelectCellEditor';
                colDef.cellEditorParams = { values: field.choices };
            }
            
            {% if has_grants %}
            // ‚úÖ Special handling for 'head' field (uses HEADS constant)
            if (field.name === 'head') {
                colDef.cellEditor = 'agSelectCellEditor';
                colDef.cellEditorParams = { values: HEADS };
            }
            {% endif %}
            
            cols.push(colDef);
        });
        
        return cols;
    }
    
    // ‚úÖ Load data from API
    function loadData() {
        showLoading(true);
        fetch(API_URL)
            .then(response => response.json())
            .then(data => {
                allData = data;
                gridApi.setGridOption('rowData', data);
                updateStats();
                updateStatus(`‚úÖ Loaded ${data.length} records`, 'success');
                showLoading(false);
            })
            .catch(error => {
                console.error('Error:', error);
                updateStatus('‚ùå Error loading data', 'error');
                showLoading(false);
            });
    }
    
    // ‚úÖ Add new row
    function addNewRow() {
        const newRow = { id: null };
        
        // Initialize fields with default values
        FIELDS_CONFIG.forEach(field => {
            if (field.name === 'date') {
                newRow[field.name] = new Date().toISOString().split('T')[0];
            } else if (field.type === 'DecimalField' || field.type === 'FloatField') {
                newRow[field.name] = 0;
            } else {
                newRow[field.name] = '';
            }
        });
        
        {% if has_grants %}
        newRow.seed_grant = null;
        newRow.tdg_grant = null;
        newRow.seed_grant_short = null;
        newRow.tdg_grant_short = null;
        newRow.grant_no_display = '';
        {% endif %}
        
        gridApi.applyTransaction({ add: [newRow], addIndex: -1 });
        updateStatus('New row added. Fill details and save.', 'warning');
    }
    
    // ‚úÖ Save changes
    async function saveChanges() {
        const allRows = [];
        gridApi.forEachNode(node => allRows.push(node.data));
        
        const newRows = allRows.filter(row => !row.id);
        const updatedRows = Array.from(modifiedRows.values());
        
        if (newRows.length === 0 && updatedRows.length === 0) {
            updateStatus('No changes to save', 'warning');
            return;
        }
        
        showLoading(true);
        
        try {
            // Create new rows
            for (const row of newRows) {
                const payload = preparePayload(row);
                
                console.log('Creating row:', payload);
                
                const createResponse = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!createResponse.ok) {
                    const errorData = await createResponse.json();
                    throw new Error(`Create failed: ${JSON.stringify(errorData)}`);
                }
            }
            
            // Update existing rows
            for (const row of updatedRows) {
                const payload = preparePayload(row);
                
                console.log('Updating row:', row.id, payload);
                
                const updateResponse = await fetch(`${API_URL}${row.id}/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!updateResponse.ok) {
                    const errorData = await updateResponse.json();
                    throw new Error(`Update failed: ${JSON.stringify(errorData)}`);
                }
            }
            
            modifiedRows.clear();
            updateStatus(`‚úÖ Saved ${newRows.length + updatedRows.length} row(s)`, 'success');
            setTimeout(() => loadData(), 1000);
            
        } catch (error) {
            console.error('Save error:', error);
            updateStatus('‚ùå Error: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    }
    
    // ‚úÖ Prepare payload for API (clean up display fields)
    function preparePayload(row) {
        const payload = {};
        
        FIELDS_CONFIG.forEach(field => {
            if (row[field.name] !== undefined && row[field.name] !== null) {
                payload[field.name] = row[field.name];
            }
        });
        
        {% if has_grants %}
        // Add grant fields
        if (row.seed_grant) payload.seed_grant = row.seed_grant;
        if (row.tdg_grant) payload.tdg_grant = row.tdg_grant;
        
        // Remove display-only fields
        delete payload.grant_no_display;
        delete payload.seed_grant_short;
        delete payload.tdg_grant_short;
        delete payload.grant_short;
        {% endif %}
        
        // Remove null/undefined values
        Object.keys(payload).forEach(key => {
            if (payload[key] === null || payload[key] === undefined || payload[key] === '') {
                delete payload[key];
            }
        });
        
        return payload;
    }
    
    // ‚úÖ Delete selected rows
    async function deleteSelected() {
        const selectedRows = gridApi.getSelectedRows();
        
        if (selectedRows.length === 0) {
            alert('Please select rows to delete');
            return;
        }
        
        if (!confirm(`Delete ${selectedRows.length} row(s)?`)) return;
        
        showLoading(true);
        
        try {
            for (const row of selectedRows) {
                if (row.id) {
                    await fetch(`${API_URL}${row.id}/`, {
                        method: 'DELETE',
                        headers: { 'X-CSRFToken': getCookie('csrftoken') }
                    });
                }
            }
            
            gridApi.applyTransaction({ remove: selectedRows });
            updateStats();
            updateStatus(`‚úÖ Deleted ${selectedRows.length} row(s)`, 'success');
            
        } catch (error) {
            console.error('Delete error:', error);
            updateStatus('‚ùå Error deleting rows', 'error');
        } finally {
            showLoading(false);
        }
    }
    
    // ‚úÖ Export to CSV
    function exportToExcel() {
        gridApi.exportDataAsCsv({
            fileName: `${MODEL_NAME}_${new Date().toISOString().split('T')[0]}.csv`
        });
        updateStatus('‚úÖ Exported to CSV', 'success');
    }
    
    // ‚úÖ Refresh data
    function refreshData() {
        modifiedRows.clear();
        loadData();
    }
    
    // ‚úÖ Track changes
    function trackChange(rowData) {
        if (rowData.id) {
            modifiedRows.set(rowData.id, rowData);
            updateStatus(`${modifiedRows.size} row(s) modified`, 'warning');
        }
    }
    
    // ‚úÖ Update stats
    function updateStats() {
        // Can be enhanced with more stats
        
    }
    
    // ‚úÖ Update status message
    function updateStatus(message, type = 'info') {
        const statusEl = document.getElementById('statusMessage');
        statusEl.textContent = message;
        statusEl.className = 'status ' + type;
    }
    
    // ‚úÖ Show/hide loading overlay
    function showLoading(show) {
        document.getElementById('loadingOverlay').classList.toggle('active', show);
    }
    
    // ‚úÖ Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}